<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Health Habit Coach</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="p-4 bg-light">

<div class="container">
  <h1 class="mb-4 text-center">ü§ñ Health Habit Coach</h1>

  <!-- Today's Progress -->
   
  <!-- Today's Progress -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white"><strong>Today‚Äôs Progress</strong></div>
    <div class="card-body">
      <ul class="list-group">
        {% for habit, amount in habits_list %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>{{ habit.capitalize() }}</span>
          <span id="value-{{ habit }}">
            {% if habit == "water" %}
              {{ amount }} glasses of water
            {% elif habit == "steps" %}
              {{ amount }} steps walked
            {% elif habit == "exercise" %}
              {{ amount }} sets
            {% elif habit == "reading" %}
              {{ amount }} pages read
            {% elif habit == "sleep" %}
              {{ amount }} hours slept
            {% else %}
              {{ amount }} hours
            {% endif %}
          </span>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <!-- <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white"><strong>Today‚Äôs Progress</strong></div>
    <div class="card-body">
      <ul class="list-group">
        {% for habit, amount in habits_list %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>{{ habit.capitalize() }}</span>
          <span id="value-{{ habit }}">{{ amount }}/{{ targets[habit] }}</span>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div> -->

  <!-- Log Habit Form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white"><strong>Log Habit</strong></div>
    <div class="card-body">
      <form method="POST" class="row g-2">
        <div class="col-auto">
          <select name="habit" class="form-select">
            {% for habit in targets.keys() %}
            <option value="{{ habit }}">{{ habit.capitalize() }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <input type="number" name="amount" min="1" value="1" class="form-control" required>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-success">Log</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Consistency Calendar -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white"><strong>Consistency Calendar (Last 30 Days)</strong></div>
    <div class="card-body text-center">
      <div class="calendar mb-2" style="font-size:18px;">{{ calendar }}</div>
      <p class="mb-0">üî• Current Streak: {{ curr_streak }} | üèÜ Best Streak: {{ best_streak }}</p>
    </div>
  </div>

  <!-- Chart.js Progress -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-warning"><strong>Last 7 Days Progress</strong></div>
    <div class="card-body">
      <canvas id="habitChart"></canvas>
    </div>
  </div>

  {% if compliment %}
  <div id="server-compliment" style="display:none;">{{ compliment }}</div>
  {% endif %}
</div>

<!-- success sound -->
<audio id="success-sound" src="{{ url_for('static', filename='success.mp3') }}"></audio>

<script>
  // -------- CONFIG ----------
  const NO_PROGRESS_DAYS_THRESHOLD = 2;
  const REMINDER_HOUR = 18;
  const POLL_INTERVAL_MS = 60 * 60 * 1000;
  // --------------------------

  function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission().then(perm => console.log("Notification permission:", perm));
    }
  }

  function showNotification(title, body, options) {
    if (!("Notification" in window)) return;
    if (Notification.permission === "granted") {
      new Notification(title, Object.assign({ body }, options || {}));
    }
  }

  function playSuccessSound() {
    const sound = document.getElementById("success-sound");
    if (!sound) return;
    sound.currentTime = 0;
    sound.play().catch(e => console.log("Sound play blocked:", e));
  }

  function burstConfetti(durationMs=2000) {
    const end = Date.now() + durationMs;
    (function frame() {
      confetti({
        particleCount: 6 + Math.floor(Math.random()*6),
        startVelocity: 30,
        spread: 360,
        ticks: 60,
        origin: { x: Math.random(), y: Math.random() - 0.2 }
      });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  function celebrate(compliment) {
    playSuccessSound();
    burstConfetti(2000);
    showNotification("üéâ Goal Completed!", compliment, {
      icon: "https://cdn-icons-png.flaticon.com/512/992/992700.png"
    });
    const alertBox = document.createElement('div');
    alertBox.className = "alert alert-success text-center mt-3";
    alertBox.textContent = "üéâ " + compliment;
    document.querySelector('.container').prepend(alertBox);
  }

  function handleStatusResponse(json) {
    if (json.completed_today) {
      if (!sessionStorage.getItem("celebrated_today")) {
        celebrate(json.compliment || "You completed today's goals!");
        sessionStorage.setItem("celebrated_today", "1");
      }
    } else {
      sessionStorage.removeItem("celebrated_today");
    }

    // Notify if no progress
    for (const [habit, days] of Object.entries(json.days_since_progress)) {
      const dsp = days === null ? Infinity : days;
      if (dsp >= NO_PROGRESS_DAYS_THRESHOLD) {
        const key = `notified_no_progress_${habit}`;
        const lastNotified = parseInt(localStorage.getItem(key) || "0");
        const now = Date.now();
        const ONE_DAY = 24*60*60*1000;
        if (now - lastNotified > ONE_DAY) {
          const body = dsp === Infinity
            ? `You haven't started with ${habit} yet ‚Äî small steps matter!`
            : `No progress on ${habit} for ${dsp} days. Try a small step now.`;
          showNotification(`Reminder: ${habit}`, body);
          localStorage.setItem(key, now.toString());
        }
      }
    }

    // Evening reminder
    const now = new Date();
    if (now.getHours() >= REMINDER_HOUR && json.incomplete_habits.length > 0) {
      const key = `notified_incomplete_today`;
      const lastNotified = parseInt(localStorage.getItem(key) || "0");
      const nowMs = Date.now();
      const ONE_DAY = 24*60*60*1000;
      if (nowMs - lastNotified > ONE_DAY) {
        const names = json.incomplete_habits.map(i => `${i.habit} (${i.value}/${i.target})`).join(", ");
        const body = `You're not done yet: ${names}. A little progress now counts.`;
        showNotification("Don't give up ‚Äî you're close!", body);
        localStorage.setItem(key, nowMs.toString());
      }
    }
  }

  async function pollStatusAndHandle() {
    try {
      const resp = await fetch("/status");
      if (!resp.ok) return console.error("Status fetch failed:", resp.status);
      const json = await resp.json();

      // update values dynamically
      for (const h of Object.keys(json.days_since_progress)) {
        const el = document.getElementById("value-" + h);
        if (el && json.incomplete_habits) {
          const found = json.incomplete_habits.find(x => x.habit === h);
          if (found) el.textContent = `${found.value}/${found.target}`;
        }
      }
      handleStatusResponse(json);
    } catch (e) {
      console.error("Error polling status:", e);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    requestNotificationPermission();

    const serverCompl = document.getElementById("server-compliment");
    if (serverCompl && serverCompl.textContent.trim() !== "" && !sessionStorage.getItem("celebrated_today")) {
      celebrate(serverCompl.textContent.trim());
      sessionStorage.setItem("celebrated_today", "1");
    }

    pollStatusAndHandle();
    setInterval(pollStatusAndHandle, POLL_INTERVAL_MS);
  });
  async function fetchAIReport() {
  try {
    const resp = await fetch("/generate_ai_feedback");
    const data = await resp.json();

    if (data.feedback) {
      // Show alert, confetti, or notification
      alert("üß† Your Weekly Report:\n\n" + data.feedback);
      showNotification("Weekly Progress Report", data.feedback);
    } else {
      alert("No data found for the last 7 days.");
    }
  } catch (err) {
    console.error("Error fetching AI feedback:", err);
  }
}

</script>

<script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
