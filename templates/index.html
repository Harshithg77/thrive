<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Thrive ‚Äì Your Wellness Coach</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2966/2966486.png">
  <style>
    * {
      font-family: 'Poppins', sans-serif;
    }
    body {
      background: linear-gradient(135deg, #d1f4f9, #fef6e4);
      min-height: 100vh;
      color: #333;
    }
    h1 {
      font-weight: 700;
      color: #2b6777;
      letter-spacing: 1px;
      text-shadow: 0 2px 3px rgba(0,0,0,0.1);
    }
    .card {
      border: none;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.7);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.15);
    }
    .card-header {
      font-weight: 600;
      font-size: 1.1rem;
      border-radius: 20px 20px 0 0 !important;
    }
    .btn-success {
      background: linear-gradient(45deg, #38b000, #70e000);
      border: none;
      border-radius: 30px;
      padding: 8px 20px;
      transition: all 0.2s ease;
    }
    .btn-success:hover {
      transform: scale(1.05);
      background: linear-gradient(45deg, #2b9348, #55a630);
    }
    .calendar {
      letter-spacing: 2px;
      font-weight: 600;
      color: #2b6777;
    }
    canvas {
      max-height: 280px;
    }
    .habit-list span:first-child {
      font-weight: 500;
      text-transform: capitalize;
    }
    .habit-list span:last-child {
      font-weight: 600;
      color: #2b6777;
    }
    .floating-btn {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: linear-gradient(135deg, #1e88e5, #42a5f5);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 14px 22px;
      font-size: 16px;
      font-weight: 600;
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .floating-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.25);
    }
    .alert-success {
      border-radius: 15px;
      font-weight: 500;
    }
  </style>
</head>

<body class="p-4">

<div class="container">
  <h1 class="text-center mb-5">üåø Thrive: Daily Habit Tracker</h1>

  <!-- Today‚Äôs Progress -->
  <div class="card mb-4">
    <div class="card-header bg-gradient bg-primary text-white">Today‚Äôs Progress</div>
    <div class="card-body habit-list">
      <ul class="list-group list-group-flush">
        {% for habit, amount in habits_list %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>{{ habit }}</span>
          <span id="value-{{ habit }}">
            {% if habit == "water" %}
              {{ amount }} glasses
            {% elif habit == "exercise" %}
              {{ amount }} sets
            {% elif habit == "sleep" %}
              {{ amount }} hrs
            {% elif habit == "study" %}
              {{ amount }} hrs
            {% else %}
              {{ amount }}
            {% endif %}
          </span>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Log Habit -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white">Log a Habit</div>
    <div class="card-body">
      <form method="POST" class="row g-3 justify-content-center align-items-center">
        <div class="col-md-4">
          <select name="habit" class="form-select rounded-pill shadow-sm">
            {% for habit in targets.keys() %}
            <option value="{{ habit }}">{{ habit.capitalize() }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <input type="number" name="amount" min="1" value="1" class="form-control rounded-pill shadow-sm text-center" required>
        </div>
        <div class="col-md-3 text-center">
          <button type="submit" class="btn btn-success">+ Add Progress</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Calendar -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white">Consistency Calendar</div>
    <div class="card-body text-center">
      <div class="calendar mb-3">{{ calendar }}</div>
      <p class="fw-semibold">üî• Current Streak: {{ curr_streak }} | üèÜ Best Streak: {{ best_streak }}</p>
    </div>
  </div>

  <!-- Chart -->
  <div class="card mb-4">
    <div class="card-header bg-warning text-dark">Your Progress (7 Days)</div>
    <div class="card-body">
      <canvas id="habitChart"></canvas>
    </div>
  </div>

  {% if compliment %}
  <div id="server-compliment" style="display:none;">{{ compliment }}</div>
  {% endif %}
</div>

<!-- Floating AI Report Button -->
<button class="floating-btn" onclick="fetchAIReport()">üß† Weekly AI Report</button>

<audio id="success-sound" src="{{ url_for('static', filename='success.mp3') }}"></audio>

<!-- Scripts -->
<script>
  // Chart.js
  document.addEventListener("DOMContentLoaded", async () => {
    const res = await fetch("/chart-data");
    const data = await res.json();
    const ctx = document.getElementById("habitChart").getContext("2d");

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          { label: 'üíß Water', data: data.water, fill: false, borderWidth: 2 },
          { label: 'üèãÔ∏è Exercise', data: data.exercise, fill: false, borderWidth: 2 },
          { label: 'üò¥ Sleep', data: data.sleep, fill: false, borderWidth: 2 },
          { label: 'üìñ Study', data: data.study, fill: false, borderWidth: 2 }
        ]
      },
      options: {
        responsive: true,
        tension: 0.4,
        plugins: {
          legend: { labels: { usePointStyle: true, font: { size: 14 } } }
        },
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: "#eee" } }
        }
      }
    });
  });

  // Fetch AI Feedback (same logic as before)
  async function fetchAIReport() {
    try {
      const resp = await fetch("/generate_ai_feedback");
      const data = await resp.json();

      if (data.feedback) {
        burstConfetti(3000);
        alert("üß† Your Weekly AI Report:\n\n" + data.feedback);
        showNotification("Weekly Wellness Report", data.feedback);
      } else {
        alert("No data found for the last 7 days.");
      }
    } catch (err) {
      console.error("Error fetching AI feedback:", err);
    }
  }

  // Basic confetti for AI report celebration
  function burstConfetti(durationMs=2000) {
    const end = Date.now() + durationMs;
    (function frame() {
      confetti({ particleCount: 5 + Math.random()*5, startVelocity: 30, spread: 360, origin: { x: Math.random(), y: Math.random()-0.2 } });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }

  function showNotification(title, body) {
    if ("Notification" in window && Notification.permission === "granted")
      new Notification(title, { body });
  }

  if ("Notification" in window && Notification.permission === "default")
    Notification.requestPermission();
</script>
</body>
</html>
